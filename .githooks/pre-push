#!/bin/bash
set -e

RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

IMAGE="ghcr.io/jx453331958/vps-calculator"

print_info() { echo -e "${GREEN}[INFO]${NC} $1"; }
print_warn() { echo -e "${YELLOW}[WARN]${NC} $1"; }
print_error() { echo -e "${RED}[ERROR]${NC} $1"; }

# Patterns that do NOT affect the Docker image
IGNORE_PATTERNS=(
    '\.md$'
    '\.env'
    '^docker-compose\.yml$'
    '^\.dockerignore$'
    '^deploy\.sh$'
    '^push-to-github\.sh$'
    '^\.githooks/'
    '^\.github/'
    '^\.claude/'
    '^src/'
    '^LICENSE$'
)

# Check if any changed files affect the Docker image
has_docker_relevant_changes() {
    local remote_sha="$1"
    local local_sha="$2"

    if echo "$remote_sha" | grep -qE '^0+$'; then
        return 0
    fi

    local changed_files
    changed_files=$(git diff --name-only "$remote_sha".."$local_sha" 2>/dev/null)

    if [ -z "$changed_files" ]; then
        return 1
    fi

    while IFS= read -r file; do
        local ignored=false
        for pattern in "${IGNORE_PATTERNS[@]}"; do
            if echo "$file" | grep -qE "$pattern"; then
                ignored=true
                break
            fi
        done
        if [ "$ignored" = false ]; then
            return 0
        fi
    done <<< "$changed_files"

    return 1
}

get_version_tag() {
    TAG=$(git tag --points-at HEAD 2>/dev/null | grep '^v' | head -1)
    if [ -n "$TAG" ]; then
        echo "$TAG"
    else
        git rev-parse --short HEAD
    fi
}

ensure_buildx() {
    if ! docker buildx inspect vps-calc-builder &>/dev/null; then
        print_info "Creating buildx builder..."
        docker buildx create --name vps-calc-builder --use
    else
        docker buildx use vps-calc-builder
    fi
}

check_login() {
    if ! python3 -c "import json; d=json.load(open('$HOME/.docker/config.json')); exit(0 if 'ghcr.io' in d.get('auths',{}) else 1)" 2>/dev/null; then
        print_error "Not logged in to ghcr.io. Run: docker login ghcr.io -u <username>"
        exit 1
    fi
}

# Read push info from stdin
NEED_BUILD=false
while read -r local_ref local_sha remote_ref remote_sha; do
    if has_docker_relevant_changes "$remote_sha" "$local_sha"; then
        NEED_BUILD=true
        break
    fi
done

if [ "$NEED_BUILD" = false ]; then
    echo ""
    print_warn "No source code changes detected. Skipping Docker build."
    echo ""
    exit 0
fi

VERSION_TAG=$(get_version_tag)

echo ""
print_info "=== Pre-push: Build & Push Docker Image ==="
print_info "Tags: latest, ${VERSION_TAG}"
echo ""

check_login
ensure_buildx

print_info "Building and pushing Docker image (amd64 + arm64)..."
docker buildx build \
    --platform linux/amd64,linux/arm64 \
    -t "${IMAGE}:latest" \
    -t "${IMAGE}:${VERSION_TAG}" \
    --push \
    .

print_info "Docker image pushed. Continuing git push..."
